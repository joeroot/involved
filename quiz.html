<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <title>Involved</title>

  <link rel="stylesheet" href="css/foundation.css" />
  <link rel="stylesheet" href="css/main.css" />

  <script type="text/javascript" src="//use.typekit.net/xuo4ojj.js"></script>
  <script src="http://www.parsecdn.com/js/parse-1.2.8.min.js"></script>
  <script src="http://js.pusher.com/2.1/pusher.min.js" type="text/javascript"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <script src="js/vendor/custom.modernizr.js"></script>
  <script src="js/vendor/ICanHaz.js"></script>
  <script src="js/main.js"></script>

</head>

<body>

  <header>
    <div class="row">
      <div class="large-8 large-centered columns text-center">
       <h2><a href="/"><img src="img/logo.png" alt="logo" style="height:25px;margin-top:-5px" /> Involved</a></h2>
      </div>
    </div>
  </header>

  <div class="container" id="question-container">
  </div>

  <script id="empty" type="text/html">
    <div class="row">
      <div class="large-8 large-centered columns">
        <div class="empty-question">
          <!--<img src="img/load.gif" alt="Loading..." />-->
          <h2>Please wait for your lecturer to send over a question</h2>
        </div>
      </div>
    </div>
  </script>

  <script id="question" type="text/html">
    <div class="row question">
      <div class="large-8 large-centered columns text-center">
        <h6>Question:</h6>
        <h3>{{ question }}</h3>
      </div>
    </div>

    <form class="answers" id="answers">
      {{#answers}}
      <div class="row">
        <div class="large-8 large-centered columns">
          <input type="checkbox" id="answer-{{ index }}" name="answer" value="{{ index }}">
          <button class="button large {{correct}}" data-object-id="{{ object_id }}" data-for="answer-{{ index }}">{{ answer }}</button>
        </div>
      </div>
      {{/answers}}
    </form>
  </script>

  <script>
    document.write('<script src=' +
                   ('__proto__' in {} ? 'js/vendor/jquery' : 'js/vendor/jquery') +
                   '.js><\/script>')
  </script>

  <script src="js/foundation.min.js"></script>
  <!--

  <script src="js/foundation/foundation.js"></script>

  <script src="js/foundation/foundation.alerts.js"></script>

  <script src="js/foundation/foundation.clearing.js"></script>

  <script src="js/foundation/foundation.cookie.js"></script>

  <script src="js/foundation/foundation.dropdown.js"></script>

  <script src="js/foundation/foundation.forms.js"></script>

  <script src="js/foundation/foundation.joyride.js"></script>

  <script src="js/foundation/foundation.magellan.js"></script>

  <script src="js/foundation/foundation.orbit.js"></script>

  <script src="js/foundation/foundation.reveal.js"></script>

  <script src="js/foundation/foundation.section.js"></script>

  <script src="js/foundation/foundation.tooltips.js"></script>

  <script src="js/foundation/foundation.topbar.js"></script>

  <script src="js/foundation/foundation.interchange.js"></script>

  <script src="js/foundation/foundation.placeholder.js"></script>

  -->

  <script>
    $(document).foundation();
    Parse.initialize("EeEFArcfnsV0d1uVCJ4K5j6y86se3cyKP5bEigcm", "TuWtuZ7iXYxkxOar3vwlVFq2jOpkHTPRilxSjllC");
    var Answer = Parse.Object.extend("Answer");
    var Question = Parse.Object.extend("Question");

    function loadQuestion(data) {
      var id = data.question_id;

      var questions = new Parse.Query(Question);

      questions.get(id, {
        success: function(question) {
          var answers = [];

          var answer_relation= new Parse.Query(Answer);
          var answers = [];

          answer_relation.equalTo("parent", question).find({
            success: function(results) {
              answers = results;

              answers = $.map(answers, function(answer, index) {
                return {
                  index: index, 
                  answer: answer.get("answer"), 
                  object_id: answer.id,
                  correct: answer.get("correct")
                }
              });

              var dom = ich.question({
                question: question.get("question"),
                answers: answers
              });

              $("#question-container").html(dom);

              $(".answers button.large").on('click', function(e){
                var for_id = $(this).data("for");
                if ($(this).hasClass("selected")) {
                  $("#" + for_id).prop('checked', false);
                  $(this).removeClass("selected");
                } else {
                  $("#" + for_id).prop('checked', true);
                  $(this).addClass("selected");
                }
                e.preventDefault();
              });
            }
          });
        },
        error: function(object, error) {
          // The object was not retrieved successfully.
          // error is a Parse.Error with an error code and description.
        }
      });

      // End loadQuestions(id)
    }

    function clearQuestion() {
      var dom = ich.empty({});
      if ($("#question-container").children().length == 0) {
        $("#question-container").html(dom);
      } else {
        $("#question-container").fadeOut(500, function() {
          $("#question-container").html(dom);
          $("#question-container").fadeIn(500);
        });
      }
    }

    function stopQuestion(data) {
      $(".answers button.large.true").addClass("reveal");
      $(".answers button.large.selected").addClass("reveal");
      $(".answers button.large:not(.selected):not(.true)").hide(500);

      var answers_length = $(".answers button.large.selected").length;
      var answers = new Parse.Query(Answer);

      $(".answers button.large.selected").each(function(){
        answer_id = $(this).data("object-id");

        answers.get(answer_id, {
          success: function(answer) {
            answer.increment("votes", 1);
            answer.save();
          },
          error: function(answer) {
          }
        });
      });

      setTimeout(function(){
        clearQuestion();
      }, 5000);
    }

    function handleQuestion(data){
      console.log(data);
      if (data.action == "start") {
        loadQuestion(data);
      } else {
        stopQuestion();
      }
    }

    $(function() {
      clearQuestion();

      var pusher = new Pusher('7638841659acb7e9cdfd', { authEndpoint: 'http://pacific-fjord-7492.herokuapp.com/auth', authTransport: 'jsonp' });

      var quiz_slug = getURLParameter('slug').toLowerCase();
      var channel = pusher.subscribe('private-'+quiz_slug);
      channel.bind('client-'+quiz_slug, handleQuestion);
    });

  </script>
</body>
</html>
