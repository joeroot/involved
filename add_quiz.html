<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Create Quiz - Involved</title>

  <link rel="stylesheet" href="css/foundation.css" />
  <link rel="stylesheet" href="css/main.css" />

  <script type="text/javascript" src="//use.typekit.net/xuo4ojj.js"></script>
  <script src="http://www.parsecdn.com/js/parse-1.2.8.min.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <script src="js/vendor/custom.modernizr.js"></script>
  <script type="text/javascript" src="js/vendor/ICanHaz.js"></script>

</head>

<body class="add-quiz-page">

  <header>
    <div class="row">
      <div class="large-12 columns text-center">
        <h2><a href="/"><img src="img/logo.png" alt="logo" style="height:25px;margin-top:-5px" /> Involved</a></h2>
      </div>
    </div>
  </header>

  <div class="large-8 columns large-centered add-quiz">

    <div class="large-8 large-centered columns text-center">
      <h4><p class="subheader">Fill out the details below to create a quiz</p></h4>
    </div>

    <form class="custom">
      <div class="row">
        <div class="large-5 columns text-right"><h4>Lecture code:</h4></div>
        <div class="large-5 columns"><input type="text" name="slug" class="ref" id="reference-code" placeholder="Short lecture code" maxlength="10"></div>
        <div class="large-5 columns"></div>
      </div>


      <div class="row" id="questions-container">

      </div>

      <div class="row">  
        <div class="columns large-4"></div>
        <div class="columns large-8">
          <button href="#" class="button admin add-question-button">Add Question</button>
        </div>
      </div>


      <div class="row">
        <div class="columns large-12 large-centered text-center">
          <button id="save-quiz" class="button admin">Save Quiz</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    document.write('<script src=' + ('__proto__' in {} ? 'js/vendor/zepto' : 'js/vendor/jquery') + '.js><\/script>')
  </script>


  <script id="question" type="text/html">

    <div class="question-template" id="question-{{questionNumber}}" question-id="{{questionNumber}}">
        <h4>QUESTION {{questionNumber}}</h4>

            <div class="add question row">
              <div class="large-12 columns"><input class="question-field" type="text" placeholder="Question" required></div>
            </div>

            <div id="answers-container">


              <div class="row">
                <div class="large-12 columns">
                  <div class="row">
                    <div class="large-8 columns header"><h5>Answers</h5></div>
                    <div class="large-2 columns text-center header"><h5>Correct</h5></div>
                    <div class="large-2 columns"></div>
                  </div>
                </div>
              </div>

            </div>
      </div>
  </script>


  <script id="answer" type="text/html">
    <div class="row answer-block" answer-id="{{answerNumber}}">
                <div class="large-12 columns">
                  <div class="row">
                    <div class="large-8 columns"><input type="text" class='an-answer' placeholder="Enter a possible answer"></div>

                    <div class="large-2 columns text-center">
                      <label for="radio1">
                        <input name="correct-{{answerNumber}}" type="radio" id="correct-answer" style="display:none;">
                        <span class="custom radio correct"></span>
                       </label>
                    </div>

                    <div class="large-2 columns">
                      <button href="#" class="button admin small remove-answer-button">-</button>
                      <button href="#" class="button admin small add-answer-button">+</button>
                    </div>
                  </div>
                </div>
              </div>
  </script>

  <script src="js/foundation.min.js"></script>

  <script>


    $(document).foundation();
    Parse.initialize("EeEFArcfnsV0d1uVCJ4K5j6y86se3cyKP5bEigcm", "TuWtuZ7iXYxkxOar3vwlVFq2jOpkHTPRilxSjllC");

    var questionNumber = 1;
    var answerNumber = 1;

    $(document).ready(function(){
      addQuestion(questionNumber);
      questionNumber += 1;
    })

    var addQuestion = function(qNumber) {
      var question = ich.question({'questionNumber': qNumber})
      $('#questions-container').append(question);
      console.log(questionNumber)
      addAnswer(questionNumber, answerNumber);
      answerNumber += 1;
    }

    var addAnswer = function(qNumber, aNumber) {
      var answer = ich.answer({'answerNumber': aNumber});
      $('#question-' + qNumber + ' #answers-container').append(answer);
    }

    $('#questions-container').on('click','.add-answer-button', function(event) {
      event.preventDefault();
      var parentQuestion = $(this).closest('.question-template').attr('question-id');
      addAnswer(parentQuestion, answerNumber);
      answerNumber += 1;
    });

    $('#questions-container').on('click','.remove-answer-button', function(event) {
      console.log('remove answer please')
      event.preventDefault();
      var parentAnswer = $(this).closest('.answer-block');
      parentAnswer.remove();
    });

    $('.add-question-button').click(function(event) {
      console.log('question')
      event.preventDefault();
      addQuestion(questionNumber);
      questionNumber += 1;
    });


    var Quiz = Parse.Object.extend("Quiz");
    var Question = Parse.Object.extend("Question");
    var Answer = Parse.Object.extend("Answer");


    $('#save-quiz').click(function(event){
      event.preventDefault();
      console.log('hoping to save quiz')

      var quiz = new Quiz();
      var slug = new $('#reference-code').val()

      quiz.save({
        slug: slug,
      }, {
        success: function(quiz) {
          console.log('Quiz saved apparently. Quiz id:' + slug);
          // window.location.replace("question_list.html?slug="+slug);
        },
        error: function(quiz, error) {
        console.log(quiz)
        // error is a Parse.Error with an error code and description.

        }
      });

      $('.question-template').each(function(quiz_index,quiz_item) {

        var the_question = $(quiz_item).find('.question-field')

        console.log($(the_question).val())
        var question = new Question();
        var questionString = $(the_question).val();
        console.log('question string:'+ questionString)

      $(quiz_item).find('.an-answer').each(function(a_index,a_item) {
          console.log('iterating answers')
          var answer = new Answer();
          var answerString = $(a_item).val();
          var radio = $(this).parent("div").next().find("span")[0];
          var correct = $(radio).hasClass("checked");
          answer.save({
            answer: answerString,
            votes: 0,
            correct:correct,
            parent: question,
          })
          console.log('answer saved')
      });

                    console.log('question saved')

      console.log('about to save quiz')

      question.save({
        question: questionString,
        quiz: quiz,
      });

      });
    });

  </script>
</body>
</html>
